[[Home|&raquo; JRuby Project Wiki Home Page]] 
<h1>Warbler</h1>

The Warbler readme at [http://caldersphere.rubyforge.org/warbler/] describes Warbler as follows:

:''[http://caldersphere.rubyforge.org/warbler/classes/Warbler.html Warbler] is a gem to make a <tt>.war</tt> file out of a [http://caldersphere.rubyforge.org/warbler/classes/Rails.html Rails], Merb, or Rack-based application. The intent is to provide a minimal, flexible, Ruby-like way to bundle all your application files for deployment to a Java application server. [http://caldersphere.rubyforge.org/warbler/classes/Warbler.html Warbler] provides a sane set of out-of-the box defaults that should allow most [http://caldersphere.rubyforge.org/warbler/classes/Rails.html Rails] applications without external gem dependencies (aside from Rails itself) to assemble and ''just work''. Warbler bundles JRuby and [[JRuby_Rack|JRuby-Rack]] for dispatching requests to your application inside the Java application server, and assembles all jar files in <tt>WARBLER_HOME/lib/*.jar</tt> into your application. No external dependencies are downloaded.''

Created by [http://blog.nicksieger.com Nick Sieger].

[http://blog.nicksieger.com/articles/2007/09/04/warbler-a-little-birdie-to-introduce-your-rails-app-to-java Announcement: Warbler, A Little Birdie To Introduce Your Rails App To Java] (Nick Sieger blog, September, 2007)<br/><br/>

__TOC__

== Defaults ==

Currently, the 0.9.12 Warbler gem includes JRuby 1.1.6 and JRuby-Rack 0.9.3.

It's also possible to set different versions of JRuby and JRuby-Rack (or GoldSpike, the previously used servlet adapter) without modifying the gem files. This ensures that your build is reproducible. There are a couple of ways to do this:
* '''Use Warbler as a plugin.'''
*# Install Warbler as a plugin:<br/> &nbsp;<tt>jruby -S warble pluginize</tt>
*# Remove existing jar files from <tt>vendor/plugins/warbler/lib</tt> and replace them with the versions you want to use.
* '''Override <tt>java_libs</tt>'''<br/>Override Warbler's <tt>java_libs</tt> so you can provide your own. You can override individual jar files, or you can remove all the defaults and provide all of your own.
**For example, to replace the version of JRruby that is bundled with your app, add the following code to <tt>config/warble.rb</tt> and put the desired <tt>jruby-complete</tt> jar into the <tt>lib</tt> directory of your rails application:<br/><tt> &nbsp;config.java_libs.reject! { |lib| lib =~ /jruby-complete/ }</tt><br/><br/>
** If you want to provide all the jars, set <tt>config.java_libs = []</tt> and put copies of all of the required jars in <tt>lib</tt>.

== Automatically Figure Out Gems ==
The following code snippet in <tt>config/warble.rb</tt> will cause Warbler to automatically bundle all gems loaded by the web application.
  # Include all gems used by the web application
  require "#{RAILS_ROOT}/config/boot"
  BUILD_GEMS = %w(warbler rake rcov)
  for gem in Gem.loaded_specs.values
    next if BUILD_GEMS.include?(gem.name)
    config.gems[gem.name] = gem.version.version
  end

==Upgrading to Warbler 0.9.9 ==
The introduction of JRuby-Rack with this release requires some changes. While it does attempt to make a smooth and gentle transition from Goldspike, if you are upgrading from a previous version, you might want to invest the time to make a clean break.

=== Required Changes to Upgrade to JRuby-Rack ===

==== warbler.rb sample diff ====

 - config.java_libs.reject! {|lib| lib =~ /jruby-complete|goldspike/ }
 - # Control the pool of Rails runtimes
 - # (Goldspike-specific; see README for details)
 - config.webxml.pool.maxActive = ENV['max'] ||= '10'
 - config.webxml.pool.minIdle = ENV['min'] ||= '4'
 - config.webxml.pool.c?heckInterval = 0
 - config.webxml.pool.maxWait = 30000
 + config.webxml.jruby.?min.runtimes = 2
 + config.webxml.jruby.?max.runtimes = 10

==== web.xml.erb sample diff ====
<pre>
  <web-app>
 - <context-param>
 - <param-name>jr?uby.standalone</p?aram-name>
 - <param-value><%= webxml.standalone %></param-value>
 - </context-param>
 -
 - <% if !webxml.standalone && webxml.jruby_home %>
 - <!-- jruby.home can be set either here, or as the system property jruby.home -->
 - <context-param>
 - <param-name>jr?uby.home</param-n?ame>
 - <param-value><%= webxml.jruby_home %></param-value>
 - </context-param>
 - <% end %>
 -
 - <context-param>
 - <param-name>ra?ils.root</param-n?ame>
 - <param-value>/?WEB-INF</param-va?lue>
 - </context-param>
 -
 - <context-param>
 - <param-name>ra?ils.env</param-na?me>
 - <param-value><%= webxml.rails_env || 'production' %></param-value>
 - </context-param>
 -
 - <% webxml.pool.marshal_dump.each do |k,v| %>
 - <context-param>
 - <param-name>jr?uby.pool.<%= k %></param-name>
 - <param-value><%= v %></param-value>
 - </context-param>
 - <% end %>
 -
 - <context-param>
 - <param-name>fi?les.default</para?m-name>
 - <param-value>r?ails</param-value?>
 - <description>
 - The files servlet should forward to the rails servlet if no file could be found
 - </description>
 - </context-param>
 -
 - <context-param>
 - <param-name>fi?les.prefix</param?-name>
 - <param-value>?</param-value>
 - <description>
 - Prefix added to static files
 - </description>
 - </context-param>
 -
 - <context-param>
 - <param-name>jr?uby.session_store?</param-name>
 - <param-value>d?b</param-value?><!--This value really means let Rails take care of session store-->
 - </context-param>
 -
 - <listener>
 - <listener-class?>org.jruby.webapp.R?ailsContextListener?</listener-class?>
 - </listener>
 -
 - <servlet>
 - <servlet-name>?rails</servlet-na?me>
 - <servlet-class?>org.jruby.webapp.Ra?ilsServlet</servl?et-class>
 - </servlet>
 - <servlet>
 - <servlet-name>?files</servlet-na?me>
 - <servlet-class?>org.jruby.webapp.Fi?leServlet</servle?t-class>
 - </servlet>
 -
 - <!-- Allow all requests to go to the files servlet first -->
 - <% servlet_name = Warbler::VERSION < "0.9.9" ?
 - webxml.servlet_name :
 - webxml.context_param?s['servlet_name'] %>
 - <servlet-mapping>
 - <servlet-name><%= servlet_name || 'files' %></servlet-name>
 - <url-pattern>/?</url-pattern>?
 - </servlet-mapping>
 -
 - <% if webxml.jndi %>
 - <resource-ref>
 - <res-ref-name><%= webxml.jndi %></res-ref-name>
 - <res-type>java?x.sql.DataSource<?/res-type>
 - <res-auth>Cont?ainer</res-auth?>
 - </resource-ref>
 - <% end %>
 +<% webxml.context_params.each do |k,v| %> 
 + <context-param>
 + <param-name><%= k %></param-name>
 + <param-value><%= v %></param-value>
 + </context-param>
 +<% end %>
 +
 + <filter>
 + <filter-name>R?ackFilter</filter?-name>
 + <filter-class>?org.jruby.rack.RackF?ilter</filter-cla?ss>
 + </filter>
 + <filter-mapping>
 + <filter-name>R?ackFilter</filter?-name>
 + <url-pattern>/?*</url-pattern?>
 + </filter-mapping>
 +
 + <listener>
 + <listener-class><%= webxml.servlet_context_listener %></listener-class>
 + </listener>
 +
 +<% if webxml.jndi then webxml.jndi.each do |jndi| %>
 + <resource-ref>
 + <res-ref-name><%= jndi %></res-ref-name>
 + <res-type>java?x.sql.DataSource<?/res-type>
 + <res-auth>Cont?ainer</res-auth?>
 + </resource-ref>
 +<% end; end %>
</pre>

=== Known Issue - <tt>PoolableObjectFactory</tt> <tt>NoClassDefFoundError</tt>===
This error indicates that the application is still attempting to use Goldspike. Ensure that you do not have <tt>goldspike.jar</tt> included in the <tt>.war</tt> file, and ensure that your <tt>web.xml</tt> file is not trying to use the old Goldspike servlet. Additionally, ensure that you don't have the Goldspike rails plug-in if you are running Rails.

Here's a sample of the error:

 org.apache.catalina.core.StandardContext listenerStart 
 SEVERE: Error configuring application listener of class org.jruby.webapp.RailsContextListener
 java.lang.NoClassDefFoundError: org/apache/commons/pool/PoolableObjectFactory
         at java.lang.Class.getDeclaredConstructors0(Native Method)
         at java.lang.Class.privateGetDeclaredConstructors(Class.java:2389)
         at java.lang.Class.getConstructor0(Class.java:2699) 

==Later Releases==
===0.9.10===
* Upgraded to JRuby-Rack 0.9.1. Fixes JRUBY-2620, JRUBY-2594, JRUBY-2507.
* Now verified to work with Camping and Sinatra. See <tt>github.com/nicksieger/jruby-rack/tree/master/examples</tt> for examples of how to configure Warbler to package your Camping and Sinatra apps.
* Upgraded to JRuby 1.1.3.
* Log files are no longer packaged in the <tt>.war</tt> file.
* Fix <tt>#&lt;Warbler::WebxmlOpenStruct …&gt;</tt> appearing in <tt>web.xml</tt> and document workarounds.
* Add <tt>config.autodeploy_dir</tt> that, when specified, will create the war there.

===0.9.11===
* Auto-detect Rails and Merb and configure appropriately
** For Rails, set rails booter, determine max runtimes based on <tt>Rails.configuration.threadsafe!</tt>, add Rails gem, detect Rails version, set gems to be packaged based on <tt>Rails.configuration.gems</tt> if available.
** Rails gems only added if Rails application detected.
** For Merb, set merb booter automatically.
* Auto-detect <tt>config.ru</tt> rackup script and pass it into <tt>config.webxml.rackup</tt>.
* <tt>rails.env</tt> now commented by default in <tt>config/warble.rb</tt>, and internally default the value to ‘production‘.
* Default directories in <tt>config.dirs</tt> to only those that are found to be present.
* Allow <tt>config.gems</tt> array to contain regexps and <tt>Gem::Dependency</tt> objects as well.
''Assist from Jani Soila''
* Fix bug ensuring you can <tt>+=</tt> and <tt>-=</tt> for <tt>config.gems</tt>.
* Upgrade to JRuby 1.1.4 and JRuby-Rack 0.9.2.
* Add <tt>[]</tt> as a way to specify non-identifier keys. For example: <tt>config.webxml[’!@#$%^’] = ‘haha‘</tt>.

===0.9.12===
* Allow framework auto-detection to be disabled. Set <tt>Warbler.framework_detection</tt> <tt>=</tt> <tt>false</tt> at the top of <tt>config/warble.rb</tt> or uncomment the line from a newly generated configuration.
* Add configuration option to set manifest file (thanks Tommy McGuire).
* Mitigate RubyGems 1.3 compatibility issue (thanks Jens Norrgrann).
* Add experimental <tt>war:exploded</tt> task to enable you to deploy your application in an exploded mode, thus allowing continual development without re-warring and re-deploying. Feedback is appreciated if you try this feature&mdash;it might not work in all application servers and for applications other than Rails.
* Handle Rails gem dependencies better (thanks Laszlo Bacsi).
* Auto-detect Merb dependencies (Merb 1.0 or later only). Please give feedback if you try Warbler with a Merb 1.0 app.
* Ignore gem development dependencies
* Upgrade to JRuby 1.1.6 and JRuby-Rack 0.9.3

== See Also ==
* [http://blogs.sun.com/arungupta/entry/rails_and_java_ee_integration1 Rails and Java EE integration - Warbler instead of Goldspike] (Arun Gupta)
* [http://fuzzypanic.blogspot.com/2008/01/jruby-war-packaging.html JRuby .war packaging (Warbler) for Rails 2.0] (Mike Herrick)
* [http://blog.nicksieger.com/articles/2007/09/04/warbler-a-little-birdie-to-introduce-your-rails-app-to-java | Warbler, A Little Birdie To Introduce Your Rails App To Java] (Nick Sieger)
